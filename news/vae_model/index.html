<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Variational Autoencoder (VAE) Model - A Simplified Math Elaboration for VAE's Loss | Umi's Corner </title> <meta name="author" content="Umi's Corner"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="machine learning, deep learning, diffusion model, generative models, LLM, computer vision, transformer"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://umi1100.github.io/news/vae_model/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Umi's Corner </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">home </a> </li> <li class="nav-item active"> <a class="nav-link" href="/news/">Inspirations <span class="sr-only">(current)</span> </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Variational Autoencoder (VAE) Model - A Simplified Math Elaboration for VAE's Loss</h1> <p class="post-meta"> January 13, 2025 </p> <p class="post-tags"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </p> </header> <article class="post-content"> <div id="markdown-content"> <p>In this post, I will elaborate the mathemtatics behind VAE’s loss. This math proof is often conveniently ignored to faciliate the model adaptation. I, however, think it’s helpful to fully understand VAE model and other laten variable models.</p> <hr> <p>First, In addition to the <a href="https://arxiv.org/pdf/1312.6114" rel="external nofollow noopener" target="_blank">original VAE paper</a>, I would like to recommend this amazing lecture video from Stanford (<a href="https://www.youtube.com/watch?v=iL1c1KmYPM0&amp;list=PLoROMvodv4rNjRoawgt72BBNwL2V7doGI&amp;index=11" rel="external nofollow noopener" target="_blank">Variational Inference and Generative Models</a>. The course about meta-learning is also very well explained.</p> <h1 id="vae">VAE</h1> <p>VAE tries to model the distribution \(p(x)\) of example data \(x\) by assuming the Gaussian distribution of the data and then training a model (parameterized by \(\theta\) (\(p_\theta(x)\)) to approximate the parameters (mean \(\mu_\theta\) and variance \(\sigma_\theta\)) of the distribution. VAE however does not approximate these parameters directly from the training examples. It instead first learns an intermediate laten variable \(z\) with prior Gaussian distribution \(p(z)\) (also approximated as a Gaussian \(q_\phi(z)\) parameterized by \(\mu_\phi\) and \(\sigma_\phi\)) to represent the data (encoding step) and then learns \(\mu_\theta\) and \(\sigma_\theta\) from this \(z\) (decoding process). This processs elaborates its name and why VAE is categorized as a Gaussian laten variable model.</p> \[\begin{aligned} p_\theta(x) &amp; = \int_z p_\theta(x|z).p(z)dz, \text(1*) \\ &amp; = \int_z p_\theta(x|z).p(z).\frac{q_\phi(z)}{q_\phi(z)}dz, \text(2*) \\ &amp; = E_{z\sim q_\phi(z)}\frac{p_\theta(x|z).p(z)}{q_\phi(z)}, \text( 3*) \\ \end{aligned}\] <blockquote> <ul> <li>(1*): the general formula to compose a more complicated distribution \(p_\theta(x)\) from two different distributions (\(p_\theta(x\|z)\) and \(p(z)\)).</li> <li>(2*): introduce another distribution to the equation by multiplying and dividing by the same distribution</li> <li>(3*): converting from integral to expectation using the relationship between integral and expectation, from which we can compute the distrubution \(p_\theta(x)\) by sampling instead of evaluating the integral.</li> </ul> </blockquote> <p>Applying log to both sides of equation (3*)</p> \[\begin{aligned} log(p_\theta(x)) &amp; = log(E_{z\sim q_\phi(z)}\frac{p_\theta(x|z).p(z)}{q_\phi(z)}) \\ &amp; &gt;= E_{z\sim q_\phi(z)}[log(p_\theta(x|z)) + log(p(z)) - log(q_\phi(z))], \text(4*)\\ &amp; = ELBO \end{aligned}\] <blockquote> <ul> <li>(4*): Applying Jenshen Inequality \(log(E(y)) &gt;= E(log(y))\) and then applying \(log(a*b/c) = log(a)+ log(b) - log(c)\)</li> </ul> </blockquote> <p>VAE trains a model to maximize \(log(p_\theta(x))\) by maximizing the lower bound ELBO. Directly optimizing for \(log(p_\theta(x))\) is extremely difficult because we need to sample lots of \(z\). The intuition of VAE is to learn \(z\) that most likely produces training examples \(x\). Hence, to further reduce the search space for the ELBO optimization process, it’s better to learn \(q_\phi(z)\) conditioned on \(x\), \(q_\phi(z\|x)\).</p> \[\begin{aligned} ELBO &amp; = E_{z\sim q_\phi(z|x)}[log(p_\theta(x|z)) + log(p(z)) - log(q_\phi(z|x))] \\ &amp; =E_{z\sim q_\phi(z|x)}[log(p_\theta(x|z))] - E_{z\sim q_\phi(z|x)}[log(\frac{q_\phi(z|x)}{p(z)}] (5*)\\ &amp; = E_{z\sim q_\phi(z|x)}[log(p_\theta(x|z))] - \sum_zq_\phi(z|x)*log(\frac{q_\phi(z|x)}{p(z)}) (6*)\\ &amp; =E_{z\sim q_\phi(z|x)}[log(p_\theta(x|z))] - D_{KL}[q_\phi(z|x)||p(z)] (7*) \end{aligned}\] <blockquote> <ul> <li>(5*): \(E(x+y) = E(x) + E(y)\)</li> <li>(6*): Applying the definition of expected value. \(E(f(x)) = \sum_xf(x).p(x)\), where \(p(x)\) is the probability density function (pdf) of \(x\).</li> <li>7(*): KL divergence definition: \(D_{KL} (P\|Q) = \sum_xP(x)log(\frac{P(x)}{Q(x)})\)</li> </ul> </blockquote> <p>One issue of this ELBO is the sampling of laten variable \(z\) for the decoding process \(log(p_\theta(x\|z))\) is not differential. To make ELBO optimizable using gradient descent, VAE applies the parameterization trick to the sampling process</p> \[\begin{aligned} z = \mu_\phi(x) + \epsilon *\sigma_\phi(x), \epsilon \sim N(0,1) \end{aligned}\] <p>\(\epsilon\) is not dependent on \(\phi\), so now we can compute gradient of ELBO with respect to \(\theta\) and \(\phi\)</p> </div> </article> <div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=determineComputedTheme(),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"umi1100/umi1100.github.io","data-repo-id":"","data-category":"Comments","data-category-id":"","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Umi's Corner. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?fcfacfb8c6281f5e68d5a7d348186eb1"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>